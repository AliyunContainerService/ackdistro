apiVersion: trident.apsara-stack.alibaba-inc.com/v1alpha1
kind: OpsTask
metadata:
  annotations:
    ark.alibaba-inc.com/name_cn: "kube-proxy\u5065\u5EB7"
  labels:
    bizType: checkTask
    check_appinstance: kube-proxy
    check_appset: k8s
    check_product: k8s
  name: check-kube-proxy-pod
  namespace: 'kube-system'
spec:
  broadcast: false
  description: "\u68C0\u67E5kube proxy\u662F\u5426\u5065\u5EB7\uFF0CPod\u72B6\u6001\
    \u6B63\u5E38\u4E14\u6570\u91CF\u6B63\u5E38"
  period: 1800
  podSpec:
    containers:
    - command:
      - bash
      - -c
      - "#!/usr/bin/env bash\n\nsource /l0/utils/l0-utils.sh\n\nerrMsg=\"\"\nret=0\n\
        check_kube_proxy() {\n    proxy_ds=\"\"\n    proxy_pods=\"\"\n\n    proxy_ds=$(kubectl\
        \ get ds -n kube-system | grep kube-proxy | awk '{print $1\";\"$2\";\"$3\"\
        ;\"$4}')\n    proxy_pods=$(kubectl get pod -n kube-system | grep kube-proxy\
        \ | awk '{print $1\";\"$2\";\"$3\";\"$4}')\n\n    # check daemonset\n    for\
        \ item in ${proxy_ds}; do\n        arr=(${item//;/ })\n        ds=${arr[0]}\n\
        \        desired=${arr[1]}\n        ready=${arr[3]}\n        if [[ ${desired}\
        \ != ${ready} ]]; then\n            echo \"daemonset[$ds] \u672A\u8FBE\u5230\
        \u7EC8\u6001pod\u6570\u76EE\uFF0C\u671F\u671B\u6570\u76EE[$desired]\uFF0C\u5B9E\
        \u9645\u6570\u76EE[$ready]\"\n            ret=1\n        fi\n    done\n  \
        \  # check pods\n    for item in ${proxy_pods}; do\n        arr=(${item//;/\
        \ })\n        name=${arr[0]}\n        status=${arr[2]}\n        if [[ ${status}\
        \ != \"Running\" ]]; then\n            echo \"network pod [$name] \u5904\u4E8E\
        \u5F02\u5E38\u72B6\u6001: $status\"\n            ret=2\n        fi\n    done\n\
        }\n\ncheck_kube_proxy\nif [[ \"$ret\" == \"0\" ]];then\n    Record \"KUBE_PROXY_CHECK\"\
        \ \"kube-proxy\" \"pass\" \"kube proxy basic check succeeded.\" \"\u68C0\u67E5\
        K8s Proxy\"\nelse\n    Record \"KUBE_PROXY_CHECK\" \"kube-proxy\" \"fail\"\
        \ \"$errMsg\" \"\u68C0\u67E5K8s Proxy\"\nfi\n\nReturn \"${TestResults}\""
      image: '{{.Values.globalconfig.RegistryURL}}/{{.Values.images.opsbasealpine.image}}:{{.Values.images.opsbasealpine.tag}}'
      imagePullPolicy: IfNotPresent
      name: main
    dnsPolicy: ClusterFirstWithHostNet
    hostNetwork: true
    tolerations:
    - effect: NoSchedule
      key: alibabacloud.com/system
    - effect: NoSchedule
      key: node-role.kubernetes.io/master
  privilegeLevel: Cluster
  suspend: {{ .Values.globalconfig.SuspendPeriodHealthCheck }}
  timeout: 180
